# Happy Vibe 开发指南 - Phase 9: MVP 完成

## 概述

**目标**: 完成 MVP 可运行版本，实现端到端数据流验证

**当前状态** (2026-02-17):
- Phase 0-8 已完成
- 测试通过率: 82% (517/630)
- 后端完成度: 85%
- 客户端完成度: 60%
- 整体 MVP 完成度: 65%

**预计完成时间**: 4.5-5 天

---

## 一、任务依赖关系图

```
                         ┌─────────────────────────────────────────────────────────────┐
                         │                    Phase 9: MVP 完成                        │
                         │                 (端到端验证 + 发布准备)                      │
                         └────────────────────────────┬────────────────────────────────┘
                                                      │
                         ┌────────────────────────────┼────────────────────────────┐
                         │                            │                            │
             ┌───────────▼───────────┐   ┌───────────▼───────────┐   ┌───────────▼───────────┐
             │     串行任务链 A      │   │     串行任务链 B      │   │     串行任务链 C      │
             │   (游戏内容完善)      │   │   (测试质量保障)      │   │   (基础设施)          │
             └───────────┬───────────┘   └───────────┬───────────┘   └───────────┬───────────┘
                         │                            │                            │
             ┌───────────▼───────────┐   ┌───────────▼───────────┐   ┌───────────▼───────────┐
             │ A2: 场景内容完善      │   │ B2: 测试修复(续)      │   │ C2: 文档完善          │
             │ (依赖 A1 资源)        │   │ (独立模块并行)        │   │ (独立进行)            │
             └───────────┬───────────┘   └───────────┬───────────┘   └───────────┬───────────┘
                         │                            │                            │
             ┌───────────▼───────────┐   ┌───────────▼───────────┐   ┌───────────▼───────────┐
             │ A1: 游戏资源创建      │   │ B1: 核心测试修复      │   │ C1: 启动脚本          │
             │ (可并行子任务)        │   │ (可并行子任务)        │   │ (独立进行)            │
             └───────────────────────┘   └───────────────────────┘   └───────────────────────┘
```

---

## 二、核心缺失内容分析

### 2.1 游戏资源文件 (关键缺失)

```
game/assets/          ← 目录不存在
├── sprites/          ← 缺少所有精灵图
│   ├── player/       ← 玩家角色图 (4方向 × 3帧动画)
│   ├── crops/        ← 作物图标 (4种 × 4品质 = 16个)
│   ├── buildings/    ← 建筑图标 (10种)
│   └── ui/           ← UI 元素 (按钮、面板、图标)
├── audio/            ← 缺少音效
│   ├── sfx/          ← 音效文件
│   └── music/        ← 背景音乐
└── fonts/            ← 字体文件
```

### 2.2 游戏场景内容

| 场景 | 状态 | 问题 |
|------|------|------|
| main_menu.tscn | ✅ 基础完成 | 可运行 |
| game_world.tscn | ❌ 空框架 | 只有30行，无实际内容 |
| hud.tscn | ❌ 空框架 | 无 UI 元素 |
| farm.tscn | ⚠️ 部分 | 需要完善 |

### 2.3 启动/部署脚本

需要创建：
- `scripts/start_backend.bat` - 启动 VibeHub
- `scripts/start_monitor.bat` - 启动监控器
- `scripts/run_all.bat` - 全部启动

---

## 三、可并行开发任务 (vibe-kanban)

这些任务**相互独立**，可以同时启动多个 vibe-kanban 工作空间：

### 批次 1: 资源与基础设施

| 任务ID | 任务名称 | 工作量 | 依赖 | 文件位置 |
|--------|----------|--------|------|----------|
| P1 | 游戏精灵资源 | 0.5天 | 无 | game/assets/sprites/ |
| P2 | 音效资源 | 0.5天 | 无 | game/assets/audio/ |
| P3 | Monitor 托盘图标 | 0.25天 | 无 | monitor/assets/ |
| P4 | 启动脚本 | 0.25天 | 无 | scripts/ |
| P8 | 文档完善 | 0.5天 | 无 | Note/, README.md |

### 批次 2: 测试修复

| 任务ID | 任务名称 | 工作量 | 依赖 | 文件位置 |
|--------|----------|--------|------|----------|
| P5 | API 测试修复 | 1天 | 无 | vibehub/tests/test_api_*.py |
| P6 | 核心模块测试修复 | 1天 | 无 | vibehub/tests/test_*.py |
| P7 | 多人系统测试修复 | 1天 | 无 | vibehub/tests/test_multiplayer*.py |

---

## 四、必须串行任务

### 串行链 A: 游戏内容

```
A1: 游戏资源创建 (0.5天)
    ↓ 依赖资源文件
A2: game_world 场景完善 (0.5天)
    ↓ 依赖场景框架
A3: HUD 完善 (0.5天)
    ↓ 依赖 UI 元素
A4: 新手引导 (0.5天)
```

**详细内容**:

#### A1: 游戏资源创建
```
创建目录结构:
game/assets/
├── sprites/
│   ├── player/
│   │   ├── player_down_1.png
│   │   ├── player_down_2.png
│   │   ├── player_down_3.png
│   │   ├── player_up_*.png
│   │   ├── player_left_*.png
│   │   └── player_right_*.png
│   ├── crops/
│   │   ├── variable_grass_q1.png
│   │   ├── variable_grass_q2.png
│   │   ├── variable_grass_q3.png
│   │   ├── variable_grass_q4.png
│   │   └── ... (其他作物)
│   ├── buildings/
│   │   ├── warehouse.png
│   │   ├── shop.png
│   │   └── ...
│   └── ui/
│       ├── button_normal.png
│       ├── button_pressed.png
│       ├── panel.png
│       └── icons/
├── audio/
│   ├── sfx/
│   │   ├── harvest.wav
│   │   ├── plant.wav
│   │   ├── level_up.wav
│   │   └── click.wav
│   └── music/
│       └── background.mp3
└── fonts/
    └── pixel_font.ttf
```

#### A2: game_world 场景完善
```gdscript
# game/scenes/main/game_world.tscn 需要添加:
- Player 节点 (带 Sprite2D, CollisionShape2D)
- Farm 节点 (包含地块 TileMap)
- Camera2D (跟随玩家)
- HUD 节点 (显示能量/等级)
- YSort (用于正确的深度排序)
```

#### A3: HUD 完善
```
HUD 需要显示:
- 能量条 (当前/最大)
- 等级和经验值
- 金币数量
- 钻石数量
- 当前状态 (心流/普通)
- 通知区域
```

#### A4: 新手引导
```
引导流程:
1. 欢迎界面
2. 解释能量系统
3. 教授种植操作
4. 教授收获操作
5. 引导查看成就
```

### 串行链 B: 测试质量

```
B1: 核心测试修复 (1天)
    ↓ 确保基础功能正常
B2: 集成测试 (0.5天)
    ↓ 验证模块间交互
B3: E2E 测试脚本 (0.5天)
```

### 串行链 C: 最终验证

```
C1: 所有组件完成后
    ↓
C2: 端到端验证 (1天)
    ↓ 完整数据流测试
C3: 发布准备 (0.5天)
```

---

## 五、开发阶段规划

### Phase 9.1: 资源与基础设施 (可完全并行)

```
并行任务组 1 (vibe-kanban):
┌────────────────────────────────────────────────────────────────┐
│  P1      P2      P3      P4      P8                            │
│ 资源    音效    图标    脚本    文档                             │
│ 0.5d   0.5d    0.25d   0.25d   0.5d                           │
└────────────────────────────────────────────────────────────────┘
                         ↓
                   预计完成: 1天
```

### Phase 9.2: 测试修复 (可完全并行)

```
并行任务组 2 (vibe-kanban):
┌────────────────────────────────────────────────────────────────┐
│  P5          P6          P7                                    │
│ API测试    核心测试    多人测试                                  │
│   1d         1d          1d                                    │
└────────────────────────────────────────────────────────────────┘
                         ↓
                   预计完成: 1天
```

### Phase 9.3: 游戏内容 (串行)

```
串行任务链:
┌────────────────────────────────────────────────────────────────┐
│  A1 → A2 → A3 → A4                                             │
│ 资源  场景  HUD  引导                                           │
│ 0.5d 0.5d 0.5d 0.5d                                            │
└────────────────────────────────────────────────────────────────┘
                         ↓
                   预计完成: 2天
```

### Phase 9.4: 验证与发布 (串行)

```
串行任务链:
┌────────────────────────────────────────────────────────────────┐
│  C2 → C3                                                       │
│ E2E  发布                                                       │
│ 1d  0.5d                                                       │
└────────────────────────────────────────────────────────────────┘
                         ↓
                   预计完成: 1.5天
```

---

## 六、完整时间线

```
Day 1:   [P1][P2][P3][P4][P8]  ← 5个任务并行 (vibe-kanban)
         资源 音效 图标 脚本 文档

Day 2:   [P5][P6][P7]          ← 3个任务并行 (vibe-kanban)
         API 核心 多人测试修复

Day 3:   [A1] → [A2]           ← 串行 (本地开发)
         资源   场景

Day 4:   [A3] → [A4]           ← 串行 (本地开发)
         HUD    引导

Day 5:   [C2]                  ← E2E验证
         端到端测试

Day 6:   [C3]                  ← 发布
         准备发布

总预计工作量: 4.5-5 天
```

---

## 七、vibe-kanban 任务详细描述

### 任务 P1: 游戏精灵资源创建

```markdown
## 目标
创建游戏所需的所有精灵图资源

## 背景
游戏当前缺少所有视觉资源，需要创建占位符或使用免费素材

## 实现步骤
1. 创建 game/assets/sprites/ 目录结构
2. 创建玩家精灵 (4方向 × 3帧 = 12张图)
3. 创建作物精灵 (4种作物 × 4品质 × 3生长阶段)
4. 创建建筑图标 (10种)
5. 创建 UI 元素 (按钮、面板、图标)

## 技术要求
- 图片格式: PNG
- 推荐尺寸: 32×32 或 64×64 像素
- 可使用 Kenney.nl 或 OpenGameArt 免费素材

## 文件位置
- 源文件: game/assets/sprites/

## 验收标准
- [ ] 所有目录结构创建完成
- [ ] 玩家精灵 12 张
- [ ] 作物精灵 48 张
- [ ] 建筑图标 10 张
- [ ] UI 元素 20+ 张
```

### 任务 P2: 音效资源创建

```markdown
## 目标
创建游戏所需的所有音效资源

## 背景
游戏缺少音效反馈，影响用户体验

## 实现步骤
1. 创建 game/assets/audio/ 目录结构
2. 添加音效文件 (harvest, plant, level_up, click)
3. 添加背景音乐

## 技术要求
- 音效格式: WAV
- 音乐格式: MP3 或 OGG
- 可使用 freesound.org 免费素材

## 文件位置
- 源文件: game/assets/audio/

## 验收标准
- [ ] sfx/ 目录有 4+ 音效文件
- [ ] music/ 目录有 1+ 背景音乐
- [ ] 所有音频可正常播放
```

### 任务 P3: Monitor 托盘图标

```markdown
## 目标
为桌面监控器创建系统托盘图标

## 背景
监控器当前使用默认图标，需要自定义品牌图标

## 实现步骤
1. 创建 monitor/assets/ 目录
2. 设计或获取图标 (16×16, 32×32, 64×64)
3. 创建不同状态图标 (正常、采集中、心流)

## 文件位置
- 源文件: monitor/assets/

## 验收标准
- [ ] icon_normal.png (正常状态)
- [ ] icon_active.png (采集中)
- [ ] icon_flow.png (心流状态)
```

### 任务 P4: 启动脚本创建

```markdown
## 目标
创建一键启动脚本，简化开发流程

## 背景
当前需要手动启动多个服务，开发效率低

## 实现步骤
1. 创建 scripts/ 目录
2. 创建 start_backend.bat (启动 VibeHub)
3. 创建 start_monitor.bat (启动监控器)
4. 创建 run_all.bat (全部启动)
5. 创建 stop_all.bat (全部停止)

## 技术要求
- Windows批处理脚本
- 自动激活虚拟环境
- 错误处理和日志输出

## 文件位置
- 源文件: scripts/

## 验收标准
- [ ] start_backend.bat 可启动 VibeHub
- [ ] start_monitor.bat 可启动监控器
- [ ] run_all.bat 可一键启动全部
- [ ] stop_all.bat 可停止所有服务
```

### 任务 P5: API 测试修复

```markdown
## 目标
修复所有 API 相关测试失败

## 背景
当前有 58 个测试失败，其中部分是 API 相关

## 实现步骤
1. 运行 pytest 获取失败列表
2. 分析 API 测试失败原因
3. 修复测试或修复代码
4. 验证所有 API 测试通过

## 文件位置
- 测试文件: vibehub/tests/test_api_*.py
- 源代码: vibehub/src/api/

## 验收标准
- [ ] API 相关测试全部通过
- [ ] 无回归问题
```

### 任务 P6: 核心模块测试修复

```markdown
## 目标
修复核心模块测试失败

## 背景
能量计算、心流检测等核心模块有测试失败

## 实现步骤
1. 分析核心模块测试失败
2. 修复 energy_calculator 测试
3. 修复 flow_detector 测试
4. 修复 season_manager 测试

## 文件位置
- 测试文件: vibehub/tests/test_energy_calculator.py 等
- 源代码: vibehub/src/core/

## 验收标准
- [ ] 核心模块测试全部通过
- [ ] 覆盖率 ≥ 80%
```

### 任务 P7: 多人系统测试修复

```markdown
## 目标
修复多人系统相关测试失败

## 背景
公会、PVP、好友等系统有测试失败

## 实现步骤
1. 分析多人系统测试失败
2. 修复公会系统测试
3. 修复 PVP 系统测试
4. 修复好友系统测试

## 文件位置
- 测试文件: vibehub/tests/test_multiplayer*.py
- 源代码: vibehub/src/multiplayer/

## 验收标准
- [ ] 多人系统测试全部通过
```

### 任务 P8: 文档完善

```markdown
## 目标
完善项目文档

## 背景
项目缺少用户指南和快速开始文档

## 实现步骤
1. 更新 README.md (安装、运行、开发)
2. 创建用户指南
3. 创建开发者指南
4. 更新 API 文档

## 文件位置
- README.md
- docs/

## 验收标准
- [ ] README 包含完整安装说明
- [ ] 用户指南包含基本操作
- [ ] 开发者指南包含架构说明
```

---

## 八、端到端验证清单

### 8.1 数据流验证

```
完整数据流测试:

1. Claude Code 日志采集
   └── Monitor 监听 ~/.claude/logs/
   └── 检测到新日志条目

2. 数据传输
   └── Monitor → VibeHub API
   └── POST /api/activity/start
   └── POST /api/activity/update
   └── POST /api/activity/end

3. 能量计算
   └── VibeHub EnergyCalculator
   └── 计算基础能量 + 加成

4. 数据同步
   └── VibeHub → Godot
   └── HTTP 轮询 或 WebSocket
   └── 更新玩家能量/经验

5. 游戏反馈
   └── Godot 显示能量增加动画
   └── 可能触发心流通知
```

### 8.2 功能验证

| 功能 | 测试方法 | 预期结果 |
|------|----------|----------|
| 服务启动 | 运行 run_all.bat | 所有服务正常启动 |
| API 健康检查 | GET /api/health | 返回 {"status": "ok"} |
| 玩家数据 | GET /api/player | 返回玩家信息 |
| 活动追踪 | POST /api/activity/start | 开始追踪 |
| 能量计算 | 完成活动 | 获得能量 |
| 游戏显示 | 打开游戏 | 显示能量/等级 |
| 作物种植 | 点击地块 | 种植作物 |
| 作物收获 | 点击成熟作物 | 获得收益 |

---

## 九、风险与应对

| 风险 | 可能性 | 影响 | 应对策略 |
|------|--------|------|----------|
| 美术资源质量 | 高 | 中 | 使用免费素材库 (Kenney, OpenGameArt) |
| 测试修复超时 | 中 | 中 | 优先修复 P0 级别测试 |
| E2E 验证失败 | 中 | 高 | 提前做小规模集成测试 |
| 并行任务冲突 | 低 | 低 | 确保任务修改不同文件 |
| API 路径不一致 | 中 | 中 | 统一使用 /api/ 前缀 |

---

## 十、完成标准

### MVP 发布标准

```
【技术检查】
✅ 所有 Blocker Bug 修复
✅ 测试通过率 ≥ 95%
✅ 性能达标 (60+ FPS, <500MB)
✅ 无内存泄漏
✅ 启动时间 < 3秒

【功能检查】
✅ 完整数据流可用
✅ 种植-收获循环完整
✅ 能量获取反馈及时
✅ 存档功能正常

【资源检查】
✅ 所有必需资源存在
✅ 资源加载无错误
✅ UI 显示正常

【文档检查】
✅ README 完整
✅ 用户指南可用
✅ API 文档更新
```

---

## 十一、下一步行动

1. **立即执行** (本地):
   - 分析测试失败原因
   - 创建游戏资源目录

2. **启动 vibe-kanban** (并行):
   - 批次 1: P1-P4, P8 (资源与基础设施)
   - 批次 2: P5-P7 (测试修复)

3. **串行开发** (本地):
   - Phase 9.3: 游戏内容完善
   - Phase 9.4: 端到端验证

---

**文档版本**: v1.0
**创建日期**: 2026-02-17
**最后更新**: 2026-02-17
